{% extends 'usuario/base.html' %}
{% block content %}
<br><br>
<div class="container mt-4 usuario-restaurante">
  <div class="d-flex justify-content-end mb-2">
    <button id="topCartButton" class="btn btn-outline-primary" title="Ver carrito">
      üçΩÔ∏è <span id="cartCount" class="badge bg-primary ms-2">0</span>
    </button>
  </div>

  {% set categorias = ['Desayuno','Almuerzo','Cena'] %}
  {% for cat in categorias %}
    <h5 class="mt-3">{{ cat }}</h5>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
      {% for p in platos if p.categoria == cat %}
        <div class="col d-flex">
          <div class="card h-100 usuario-card w-100">
            <img src="{{ url_for('static', filename=p.imagen or 'img/default_food.jpg') }}" class="usuario-card-img">
            <div class="card-body d-flex flex-column">
              <h6 class="mb-1">{{ p.nombre }}</h6>
              <p class="text-muted small mb-2">{{ p.descripcion or '' }}</p>
              <p class="fw-bold mb-2">${{ '{:,.0f}'.format(p.precio|float) }}</p>
              <div class="mt-auto d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#infoPlato{{ p.idPlato }}">Especificaciones</button>
                <button type="button" class="btn btn-success btn-sm" data-add-to-cart="1"
                        data-id="{{ p.idPlato }}"
                        data-nombre="{{ p.nombre }}"
                        data-precio="{{ p.precio }}"
                        data-img="{{ url_for('static', filename=p.imagen or 'img/default_food.jpg') }}">
                  Reservar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal info plato -->
        <div class="modal fade" id="infoPlato{{ p.idPlato }}" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header"><h5>{{ p.nombre }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body">
                <img src="{{ url_for('static', filename=p.imagen or 'img/default_food.jpg') }}" class="img-fluid mb-2">
                <p><strong>Precio:</strong> ${{ '{:,.0f}'.format(p.precio) }}</p>
                <p>{{ p.descripcion }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal reservar plato (formulario espec√≠fico para este plato) -->
        <div class="modal fade" id="reservarPlato{{ p.idPlato }}" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <form method="POST" action="{{ url_for('usuario_restaurante.reservar') }}">
                <input type="hidden" name="idPlato[]" value="{{ p.idPlato }}">
                <div class="modal-header">
                  <h5>Reservar: {{ p.nombre }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                      <label class="form-label">Nombre</label>
                      <input class="form-control" name="cliente_nombre[]" required>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Tel√©fono</label>
                      <input class="form-control" name="cliente_telefono[]">
                    </div>
                    <div class="mb-2">
                      <label class="form-label">N√∫mero de documento</label>
                      <input class="form-control" name="numeroDocumento" required>
                    </div>
                  <div class="mb-2">
                    <label class="form-label">Mesa</label>
                    <select class="form-select" name="idMesa" required>
                      <option value="" disabled selected>Seleccione mesa</option>
                      {% for m in mesas %}
                        <option value="{{ m.idMesa }}">Mesa {{ m.numeroMesa }} (Capacidad: {{ m.capacidad }})</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">Fecha</label>
                      <input type="date" class="form-control" name="fecha" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Hora</label>
                      <input type="time" class="form-control" name="hora" required>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button class="btn btn-success" type="submit">Reservar y generar factura</button>
                </div>
              </form>
            </div>
          </div>
        </div>

      {% endfor %}
    </div>
  {% endfor %}

</div>

  </div>

</div>

<!-- Bot√≥n flotante del carrito -->
<button id="cartButton" class="btn btn-primary position-fixed" style="bottom: 20px; right: 20px; border-radius: 50%; width: 60px; height: 60px; z-index: 1000;">
  üõí
  <span id="cartFloatingCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
    0
  </span>
</button>

<!-- Modal del carrito -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Carrito de Compras</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="cart-items" class="list-group mb-3">
          <!-- Los items del carrito se insertar√°n aqu√≠ din√°micamente -->
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Subtotal: <span id="cartSubtotal">$0</span></h5>
          <button id="clearCart" class="btn btn-outline-danger btn-sm">Limpiar carrito</button>
        </div>

        <!-- Informaci√≥n del cliente para generar factura -->
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Informaci√≥n para la reserva</h6>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input id="cart_nombre" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Tel√©fono</label>
                <input id="cart_telefono" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">N√∫mero de documento</label>
                <input id="cart_documento" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Mesa</label>
                <select id="cart_mesa" class="form-select" required>
                  <option value="" disabled selected>Seleccione mesa</option>
                  {% for m in mesas %}
                    <option value="{{ m.numeroMesa }}">Mesa {{ m.numeroMesa }} (Capacidad: {{ m.capacidad }})</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Fecha</label>
                <input id="cart_fecha" type="date" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Hora</label>
                <input id="cart_hora" type="time" class="form-control" required>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continuar comprando</button>
        <button id="generateCartInvoice" type="button" class="btn btn-success">Generar factura</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal factura del carrito -->
<div class="modal fade" id="cartInvoiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Factura Generada</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="cart-invoice-body">
        <!-- La factura se generar√° aqu√≠ din√°micamente -->
      </div>
      <div class="modal-footer">
        <button id="download-cart-invoice" class="btn btn-primary">Descargar PDF</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal factura (igual que ya tienes, se muestra si backend env√≠a invoice) -->
<div class="modal fade" id="modalFactura" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="factura-content">
      <div class="modal-header">
        <h5 class="modal-title">Factura</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="factura-html">
        {% if invoice %}
          <div id="invoice-area" class="p-3">
            <h4>Isla Encanto</h4>
            <p><strong>Mesa:</strong> {{ invoice.mesa_numero }}</p>
            <p><strong>Fecha:</strong> {{ invoice.fecha }} ‚Äî <strong>Hora:</strong> {{ invoice.hora }}</p>
            <hr>
            <h6>Clientes:</h6>
            <ul>
              {% for c in invoice.clientes %}
                <li>{{ c.nombre }} {% if c.telefono %}- {{ c.telefono }}{% endif %}</li>
              {% endfor %}
            </ul>
            <hr>
            <h6>Platos</h6>
            <ul>
              {% for p in invoice.platos %}
                <li>{{ p.nombre }} ‚Äî ${{ '{:,.0f}'.format(p.precio) }}</li>
              {% endfor %}
            </ul>
            <hr>
            <h5>Total: ${{ '{:,.0f}'.format(invoice.total) }}</h5>
          </div>
        {% else %}
          <p>No hay factura disponible.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button id="download-invoice" class="btn btn-primary">Descargar PDF</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Carrito funcional completo
(function() {
  'use strict';
  
  console.log('Inicializando carrito...');
  
  const STORAGE_KEY = 'restaurant_cart';
  let cart = [];
  
  // Verificar que los elementos existan
  console.log('Verificando elementos del DOM...');
  
  // Elementos del DOM
  const cartCount = document.getElementById('cartCount');
  const cartFloatingCount = document.getElementById('cartFloatingCount');
  const cartItems = document.getElementById('cart-items');
  const cartSubtotal = document.getElementById('cartSubtotal');
  const cartModalEl = document.getElementById('cartModal');
  
  console.log('Elementos encontrados:', {
    cartCount: !!cartCount,
    cartFloatingCount: !!cartFloatingCount,
    cartItems: !!cartItems,
    cartSubtotal: !!cartSubtotal,
    cartModalEl: !!cartModalEl
  });
  
  if (!cartModalEl) {
    console.error('Modal del carrito no encontrado');
    return;
  }
  
  const cartModal = new bootstrap.Modal(cartModalEl);
  const clearBtn = document.getElementById('clearCart');
  const generateBtn = document.getElementById('generateCartInvoice');
  const invoiceModalEl = document.getElementById('cartInvoiceModal');
  
  if (!invoiceModalEl) {
    console.error('Modal de factura no encontrado');
    return;
  }
  
  const invoiceModal = new bootstrap.Modal(invoiceModalEl);
  
  // Cargar carrito del localStorage
  function loadCart() {
    try {
      cart = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    } catch (e) {
      cart = [];
    }
  }
  
  // Guardar carrito en localStorage
  function saveCart() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
  }
  
  // Agregar producto al carrito
  function addToCart(id, nombre, precio, imagen) {
    console.log('addToCart llamada con:', {id, nombre, precio, imagen});
    
    const existing = cart.find(item => item.id === id);
    
    if (existing) {
      existing.qty += 1;
      console.log('Producto existente, nueva cantidad:', existing.qty);
    } else {
      const newItem = {
        id: id,
        nombre: nombre,
        precio: parseFloat(precio),
        imagen: imagen,
        qty: 1
      };
      cart.push(newItem);
      console.log('Nuevo producto agregado:', newItem);
    }
    
    saveCart();
    updateCartUI();
    console.log('Carrito actualizado:', cart);
  }
  
  // Actualizar interfaz del carrito
  function updateCartUI() {
    // Actualizar contadores
    const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
    cartCount.textContent = totalItems;
    cartFloatingCount.textContent = totalItems;
    
    // Renderizar items del carrito
    renderCartItems();
  }
  
  // Renderizar items en el modal del carrito
  function renderCartItems() {
    cartItems.innerHTML = '';
    let subtotal = 0;
    
    if (cart.length === 0) {
      cartItems.innerHTML = '<p class="text-muted text-center py-4">El carrito est√° vac√≠o</p>';
      cartSubtotal.textContent = '$0';
      return;
    }
    
    cart.forEach(item => {
      subtotal += item.precio * item.qty;
      
      const itemElement = document.createElement('div');
      itemElement.className = 'list-group-item';
      itemElement.innerHTML = `
        <div class="d-flex gap-3 align-items-center">
          <img src="${item.imagen}" alt="${item.nombre}" style="width:80px;height:60px;object-fit:cover;border-radius:8px;" class="cart-item-image">
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="mb-1">${item.nombre}</h6>
                <small class="text-muted">$${item.precio.toLocaleString()} c/u</small>
              </div>
              <div class="text-end">
                <div class="fw-bold">$${(item.precio * item.qty).toLocaleString()}</div>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <div class="input-group quantity-controls" style="width: 140px;">
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeQuantity('${item.id}', -1)">-</button>
                <input class="form-control form-control-sm text-center" type="number" min="1" value="${item.qty}" onchange="setQuantity('${item.id}', this.value)">
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeQuantity('${item.id}', 1)">+</button>
              </div>
              <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${item.id}')" title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      cartItems.appendChild(itemElement);
    });
    
    cartSubtotal.textContent = '$' + subtotal.toLocaleString();
  }
  
  // Cambiar cantidad
  window.changeQuantity = function(id, delta) {
    const item = cart.find(item => item.id === id);
    if (item) {
      item.qty = Math.max(1, item.qty + delta);
      saveCart();
      updateCartUI();
    }
  };
  
  // Establecer cantidad espec√≠fica
  window.setQuantity = function(id, quantity) {
    const item = cart.find(item => item.id === id);
    if (item) {
      item.qty = Math.max(1, parseInt(quantity) || 1);
      saveCart();
      updateCartUI();
    }
  };
  
  // Eliminar del carrito
  window.removeFromCart = function(id) {
    cart = cart.filter(item => item.id !== id);
    saveCart();
    updateCartUI();
  };
  
  // Event listeners
  document.addEventListener('click', function(e) {
    console.log('Click detectado en:', e.target);
    console.log('Clases del elemento:', e.target.className);
    
    // Botones de agregar al carrito
    const addButton = e.target.closest('[data-add-to-cart]');
    if (addButton) {
      console.log('¬°Bot√≥n del carrito encontrado!', addButton);
      e.preventDefault();
      
      const id = addButton.getAttribute('data-id');
      const nombre = addButton.getAttribute('data-nombre');
      const precio = addButton.getAttribute('data-precio');
      const imagen = addButton.getAttribute('data-img');
      
      console.log('Datos extra√≠dos:', {id, nombre, precio, imagen});
      
      if (id && nombre && precio) {
        addToCart(id, nombre, precio, imagen);
      } else {
        console.error('Faltan datos del producto:', {id, nombre, precio, imagen});
      }
    } else {
      console.log('No es un bot√≥n del carrito');
    }
  });
  
  // Abrir carrito
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM completamente cargado, configurando event listeners...');
    
    const topButton = document.getElementById('topCartButton');
    const floatingButton = document.getElementById('cartButton');
    
    console.log('Botones del carrito:', {
      topButton: !!topButton,
      floatingButton: !!floatingButton
    });
    
    if (topButton) {
      topButton.addEventListener('click', () => {
        console.log('Abriendo carrito desde bot√≥n superior');
        cartModal.show();
      });
    }
    
    if (floatingButton) {
      floatingButton.addEventListener('click', () => {
        console.log('Abriendo carrito desde bot√≥n flotante');
        cartModal.show();
      });
    }
    
    // Configurar bot√≥n de limpiar carrito
    if (clearBtn) {
      clearBtn.addEventListener('click', function() {
        if (confirm('¬øEst√°s seguro de que quieres limpiar el carrito?')) {
          cart = [];
          saveCart();
          updateCartUI();
        }
      });
    }
    
    // Configurar bot√≥n de generar factura
    if (generateBtn) {
      generateBtn.addEventListener('click', function() {
        if (cart.length === 0) {
          alert('El carrito est√° vac√≠o');
          return;
        }
        
        const nombre = document.getElementById('cart_nombre').value.trim();
        const documento = document.getElementById('cart_documento').value.trim();
        const mesa = document.getElementById('cart_mesa').value;
        const fecha = document.getElementById('cart_fecha').value;
        const hora = document.getElementById('cart_hora').value;
        
        if (!nombre || !documento || !mesa || !fecha || !hora) {
          alert('Por favor complete todos los campos obligatorios');
          return;
        }
        
        const telefono = document.getElementById('cart_telefono').value.trim();
        
        // Generar HTML de la factura
        let total = 0;
        const itemsHtml = cart.map(item => {
          total += item.precio * item.qty;
          return `
            <tr>
              <td class="text-center">${item.qty}</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <img src="${item.imagen}" style="width:50px;height:38px;object-fit:cover;border-radius:4px;">
                  <span>${item.nombre}</span>
                </div>
              </td>
              <td class="text-end">$${item.precio.toLocaleString()}</td>
              <td class="text-end">$${(item.precio * item.qty).toLocaleString()}</td>
            </tr>
          `;
        }).join('');
        
        const invoiceHtml = `
          <div id="cart-invoice-area" class="p-3">
            <div class="text-center mb-4">
              <h3>üèùÔ∏è Isla Encanto</h3>
              <h5>Factura de Restaurante</h5>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <p><strong>Cliente:</strong> ${nombre}</p>
                ${telefono ? `<p><strong>Tel√©fono:</strong> ${telefono}</p>` : ''}
                <p><strong>Documento:</strong> ${documento}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Mesa:</strong> Mesa ${mesa}</p>
                <p><strong>Fecha:</strong> ${fecha}</p>
                <p><strong>Hora:</strong> ${hora}</p>
              </div>
            </div>
            
            <hr>
            
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th class="text-center">Cant.</th>
                  <th>Producto</th>
                  <th class="text-end">Precio U.</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
            </table>
            
            <hr>
            
            <div class="text-end">
              <h4><strong>Total: $${total.toLocaleString()}</strong></h4>
            </div>
            
            <div class="text-center mt-4">
              <small class="text-muted">¬°Gracias por su preferencia!</small>
            </div>
          </div>
        `;
        
        document.getElementById('cart-invoice-body').innerHTML = invoiceHtml;
        invoiceModal.show();
      });
    }
    
    // Configurar bot√≥n de descarga
    const downloadBtn = document.getElementById('download-cart-invoice');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', function() {
        const element = document.getElementById('cart-invoice-area');
        if (!element) {
          alert('No hay factura para descargar');
          return;
        }
        
        const options = {
          margin: 0.5,
          filename: `factura_isla_encanto_${new Date().toISOString().split('T')[0]}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        
        html2pdf().set(options).from(element).save();
      });
    }
  });
  
  // Inicializaci√≥n
  loadCart();
  updateCartUI();
  
})();
</script>

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
{% endblock %}
