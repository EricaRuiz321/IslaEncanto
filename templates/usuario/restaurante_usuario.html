{% extends 'usuario/base.html' %}
{% block content %}
<br><br>

<div class="container mt-4 usuario-restaurante">
    
    <div class="text-center mb-4">
        <h2 class="fw-bold">Nuestro Men√∫</h2>
        <p class="text-muted">Disfruta de todos nuestros platos disponibles</p>
    </div>

    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
        {% for p in platos %}
        <div class="col d-flex">
            <div class="card h-100 usuario-card w-100">
                <img src="{{ url_for('static', filename=p.imagen or 'img/default_food.jpg') }}" class="usuario-card-img">

                <div class="card-body d-flex flex-column">
                    <h6 class="mb-1">{{ p.nombre }}</h6>
                    <p class="text-muted small mb-2">{{ p.descripcion or '' }}</p>
                    <p class="fw-bold mb-2">${{ '{:,.0f}'.format(p.precio|float) }}</p>

                    <div class="mt-auto d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#infoPlato{{ p.idPlato }}">Especificaciones</button>

                        <button type="button" class="btn btn-success btn-sm"
                            data-add-to-cart="1"
                            data-id="{{ p.idPlato }}"
                            data-nombre="{{ p.nombre }}"
                            data-precio="{{ p.precio }}"
                            data-img="{{ url_for('static', filename=p.imagen or 'img/default_food.jpg') }}">
                            Reservar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="infoPlato{{ p.idPlato }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>{{ p.nombre }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <img src="{{ url_for('static', filename=p.imagen or 'img/default_food.jpg') }}" class="img-fluid mb-2">
                        <p><strong>Precio:</strong> ${{ '{:,.0f}'.format(p.precio) }}</p>
                        <p>{{ p.descripcion }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<button id="cartButton" 
    class="btn btn-primary position-fixed"
    data-bs-toggle="modal" 
    data-bs-target="#cartModal"
    style="bottom: 20px; right: 20px; border-radius: 50%; width: 60px; height: 60px; z-index: 1000;">
    üõí
    <span id="cartFloatingCount"
        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
</button>


<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content rounded-3 shadow-sm">

            <div class="modal-header border-0 pb-0">
                <h4 class="modal-title fw-bold text-primary">
                    <span style="font-size: 1.5rem;">&#128722;</span> Tu Carrito
                </h4>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body pt-0">
                <div id="cart-items" class="mb-3"></div>

                <div id="cart-footer-summary" class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <h5 class="mb-0">Total:</h5>
                    <h4 class="mb-0 text-primary fw-bolder" id="cartSubtotal">$0</h4>
                </div>

                <button id="openReservationInfo" class="btn btn-primary w-100 mt-3 py-2 fw-bold" 
                        data-bs-target="#cartInvoiceModal" disabled>
                    &#10003; Confirmar Pedido
                </button>
                
                <div class="text-center mt-2">
                    <button id="clearCart" class="btn btn-link btn-sm text-danger">Limpiar carrito</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reservationInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Informaci√≥n para la Reserva</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="reservation-items-summary" class="mb-3"></div> 
                
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white"><h6 class="mb-0">Datos de Contacto y Reserva</h6></div>

                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Nombre</label>
                                <input id="cart_nombre" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tel√©fono</label>
                                <input id="cart_telefono" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">N√∫mero de documento</label>
                                <input id="cart_documento" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mesa</label>
                                <select id="cart_mesa" class="form-select" required>
                                    <option value="" disabled selected>Seleccione mesa</option>
                                    {% for m in mesas %}
                                    <option value="{{ m.idMesa }}">Mesa {{ m.numeroMesa }} (Capacidad: {{ m.capacidad }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Fecha</label>
                                <input id="cart_fecha" type="date" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hora</label>
                                <input id="cart_hora" type="time" class="form-control" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-target="#cartModal" data-bs-toggle="modal">Volver al carrito</button>
                <button id="generateCartInvoice" class="btn btn-primary">Generar Factura y Confirmar</button>
            </div>

        </div>
    </div>
</div>


<div class="modal fade" id="cartInvoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Factura Generada</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="cart-invoice-body"></div>

            <div class="modal-footer">
                <button id="download-cart-invoice" class="btn btn-secondary" disabled>Descargar PDF (WIP)</button>
                <button id="confirm-reservation" class="btn btn-primary">Confirmar y Enviar Reserva</button>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    const RESERVAR_URL = "{{ url_for('reservarmenu_bp.reservar_carrito') }}";
    const STORAGE_KEY = 'restaurant_cart';
    let cart = [];
    let clientData = {}; 

    const cartFloatingCount = document.getElementById('cartFloatingCount');
    const cartItems = document.getElementById('cart-items');
    const cartSubtotal = document.getElementById('cartSubtotal');
    
    // Nombres de ID ajustados y nuevo modal de reserva
    const cartModalEl = document.getElementById('cartModal');
    const reservationInfoModalEl = document.getElementById('reservationInfoModal');
    const invoiceModalEl = document.getElementById('cartInvoiceModal');

    const cartModal = cartModalEl ? new bootstrap.Modal(cartModalEl) : null;
    const reservationInfoModal = reservationInfoModalEl ? new bootstrap.Modal(reservationInfoModalEl) : null;
    const invoiceModal = invoiceModalEl ? new bootstrap.Modal(invoiceModalEl) : null;
    
    const openReservationInfoBtn = document.getElementById('openReservationInfo');
    const generateInvoiceBtn = document.getElementById('generateCartInvoice');
    const confirmReservationBtn = document.getElementById('confirm-reservation');
    const cartInvoiceBody = document.getElementById('cart-invoice-body');
    const clearCartBtn = document.getElementById('clearCart');

    function loadCart() {
        try { cart = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
        catch { cart = []; }
    }

    function saveCart() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
    }

    function formatCurrency(number) {
        // Uso de 'es-CO' para el formato colombiano si aplica, o 'es-ES' para general.
        return '$' + Math.round(number).toLocaleString('es-CO');
    }

    function addToCart(id, nombre, precio, imagen) {
        const existing = cart.find(i => String(i.id) === String(id));
        if (existing) existing.qty++;
        else cart.push({ id: String(id), nombre, precio: parseFloat(precio), imagen, qty: 1 });

        saveCart();
        updateCartUI();
        if(cartModal) cartModal.show();
    }

    function changeQty(id, delta) {
        const itemIndex = cart.findIndex(i => String(i.id) === String(id));
        if (itemIndex > -1) {
            cart[itemIndex].qty = Math.max(1, cart[itemIndex].qty + delta);
            saveCart();
            updateCartUI();
        }
    }

    function removeItem(id) {
        cart = cart.filter(i => String(i.id) !== String(id));
        saveCart();
        updateCartUI();
    }

    function updateCartUI() {
        const totalItems = cart.reduce((a, i) => a + i.qty, 0);
        if (cartFloatingCount) cartFloatingCount.textContent = totalItems;
        renderCartItems();

        // Habilita el bot√≥n de confirmar pedido si hay items
        if (openReservationInfoBtn) {
            openReservationInfoBtn.disabled = cart.length === 0;
        }
    }

    // Dibuja el contenido del carrito con el nuevo dise√±o
    function renderCartItems() {
        if (!cartItems) return;
        cartItems.innerHTML = '';
        let subtotal = 0;

        if (!cart.length) {
            cartItems.innerHTML = '<p class="text-muted text-center py-4">El carrito est√° vac√≠o</p>';
            if (cartSubtotal) cartSubtotal.textContent = '$0';
            return;
        }

        cart.forEach(item => {
            const totalItem = item.precio * item.qty;
            subtotal += totalItem;

            const div = document.createElement('div');
            // La clase shadow-sm y rounded-3 imita el aspecto de tarjeta de tu imagen
            div.className = 'd-flex align-items-center mb-3 p-3 bg-white border rounded-3 shadow-sm';
            div.innerHTML = `
                <img src="${item.imagen}" class="me-3" style="width:50px;height:50px;border-radius:4px;object-fit:cover;">
                
                <div class="flex-grow-1">
                    <h6 class="mb-0 fw-bold">${item.nombre}</h6>
                    <span class="small text-muted">${formatCurrency(item.precio)}</span>
                </div>
                
                <div class="d-flex align-items-center me-3">
                    <button class="btn btn-outline-primary btn-sm rounded-circle p-0" style="width: 24px; height: 24px;" data-change-qty="${item.id}" data-delta="-1">&#8722;</button>
                    <span class="mx-2 fw-bold" style="min-width: 15px; text-align: center;">${item.qty}</span>
                    <button class="btn btn-outline-primary btn-sm rounded-circle p-0" style="width: 24px; height: 24px;" data-change-qty="${item.id}" data-delta="1">&#43;</button>
                </div>

                <div class="d-flex align-items-center">
                    <strong class="text-end me-3">${formatCurrency(totalItem)}</strong>
                    <button class="btn btn-outline-danger btn-sm p-0" style="border: none; background: none; color: #dc3545;" data-remove-item="${item.id}">
                        <i class="bi bi-trash"></i> üóëÔ∏è
                    </button>
                </div>
            `;
            cartItems.appendChild(div);
        });

        if (cartSubtotal) cartSubtotal.textContent = formatCurrency(subtotal);
    }
    
    // ==========================================================
    // Event Listeners
    // ==========================================================

    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-add-to-cart]');
        if (btn) {
            e.preventDefault();
            addToCart(btn.dataset.id, btn.dataset.nombre, btn.dataset.precio, btn.dataset.img);
            return;
        }

        const changeBtn = e.target.closest('[data-change-qty]');
        if (changeBtn) {
            changeQty(changeBtn.dataset.changeQty, parseInt(changeBtn.dataset.delta, 10));
            return;
        }

        const removeBtn = e.target.closest('[data-remove-item]');
        if (removeBtn) {
            removeItem(removeBtn.dataset.removeItem);
            return;
        }
        
        // Listener para el bot√≥n "Limpiar carrito"
        if (e.target.id === 'clearCart' && clearCartBtn) {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el carrito?')) {
                cart = [];
                saveCart();
                updateCartUI();
            }
        }
    });

    // Nuevo Listener para el bot√≥n "Confirmar Pedido"
    if (openReservationInfoBtn) {
        openReservationInfoBtn.addEventListener('click', function() {
            if (!cart.length) {
                alert('El carrito est√° vac√≠o.');
                return;
            }
            cartModal.hide();
            // Abre el modal de informaci√≥n para la reserva (tu formulario)
            reservationInfoModal.show(); 
        });
    }
    
    // Listener para el bot√≥n "Generar Factura y Confirmar" (en el modal de Reserva)
    if (generateInvoiceBtn) {
        generateInvoiceBtn.addEventListener('click', function() {
             if (!cart.length) {
                alert('El carrito est√° vac√≠o.');
                return;
            }

            // Recoger y validar datos del cliente
            clientData = {
                nombre: document.getElementById('cart_nombre').value.trim(),
                telefono: document.getElementById('cart_telefono').value.trim(),
                documento: document.getElementById('cart_documento').value.trim(),
                idMesa: document.getElementById('cart_mesa').value,
                mesaDisplay: document.getElementById('cart_mesa').options[document.getElementById('cart_mesa').selectedIndex].text,
                fecha: document.getElementById('cart_fecha').value,
                hora: document.getElementById('cart_hora').value,
            };

            const requiredFields = [clientData.nombre, clientData.documento, clientData.idMesa, clientData.fecha, clientData.hora];
            
            if (requiredFields.some(val => !val) || clientData.idMesa === "") {
                alert('Por favor, complete todos los campos de informaci√≥n (Nombre, Documento, Mesa, Fecha, Hora) antes de generar la factura.');
                return;
            }
            
            // Generar contenido HTML de la Factura
            let total = cart.reduce((sum, item) => sum + (item.precio * item.qty), 0);
            
            let html = `
                <div class="mb-4">
                    <h6>Detalles del Cliente y Reserva</h6>
                    <ul class="list-unstyled small">
                        <li><strong>Nombre:</strong> ${clientData.nombre}</li>
                        <li><strong>Documento:</strong> ${clientData.documento}</li>
                        <li><strong>Tel√©fono:</strong> ${clientData.telefono || 'No especificado'}</li>
                        <li><strong>Mesa:</strong> ${clientData.mesaDisplay}</li>
                        <li><strong>Fecha/Hora:</strong> ${clientData.fecha} - ${clientData.hora}</li>
                    </ul>
                </div>
                
                <h6>Detalle de Platos</h6>
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Plato</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-end">Precio Unitario</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cart.map(item => `
                            <tr>
                                <td>${item.nombre}</td>
                                <td class="text-center">${item.qty}</td>
                                <td class="text-end">${formatCurrency(item.precio)}</td>
                                <td class="text-end">${formatCurrency(item.precio * item.qty)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" class="text-end">Total a Pagar:</th>
                            <th class="text-end">${formatCurrency(total)}</th>
                        </tr>
                    </tfoot>
                </table>
                <p class="mt-4 text-center text-muted small">
                    Verifique los datos antes de confirmar.
                </p>
            `;
            
            cartInvoiceBody.innerHTML = html;
            reservationInfoModal.hide();
            invoiceModal.show();
        });
    }

    // Confirmar Reserva y Enviar a Flask (en el modal de Factura)
    if (confirmReservationBtn) {
        confirmReservationBtn.addEventListener('click', async function() {
            // L√≥gica de env√≠o a Flask... (la he dejado como la ten√≠as)
            if (!cart.length || !clientData || !clientData.idMesa) {
                alert('Error en los datos de la reserva. Por favor, intente generar la factura de nuevo.');
                invoiceModal.hide();
                reservationInfoModal.show();
                return;
            }

            confirmReservationBtn.disabled = true;
            confirmReservationBtn.textContent = 'Enviando reserva...';

            const dataToSend = {
                nombre: clientData.nombre,
                telefono: clientData.telefono,
                documento: clientData.documento,
                mesa: clientData.idMesa,
                fecha: clientData.fecha,
                hora: clientData.hora,
                platos: cart.map(item => ({
                    idPlato: item.id,
                    cantidad: item.qty,
                    precio: item.precio
                }))
            };

            try {
                const response = await fetch(RESERVAR_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('‚úÖ Reserva enviada con √©xito. ID de Reserva: ' + result.id_reserva);
                    // Limpiar carrito y cerrar modal
                    cart = [];
                    saveCart();
                    updateCartUI();
                    invoiceModal.hide();
                } else {
                    alert('‚ùå Error al procesar la reserva: ' + (result.error || 'Int√©ntelo de nuevo.'));
                }
            } catch (error) {
                console.error('Error de red al enviar la reserva:', error);
                alert('‚ùå Fallo de conexi√≥n al servidor. Por favor, verifique su conexi√≥n.');
            } finally {
                confirmReservationBtn.disabled = false;
                confirmReservationBtn.textContent = 'Confirmar y Enviar Reserva';
            }
        });
    }

    loadCart();
    updateCartUI();

})();
</script>
{% endblock %}